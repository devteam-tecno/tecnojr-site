import { Meta } from "@storybook/blocks";

<Meta title="Documentation/Deployment" />

# Deployment Guide

Complete guide for building and deploying the TecnoJr website and Storybook documentation.

## Quick Start

### Build for Production
```bash
# Build Next.js application
npm run build

# Build Storybook documentation
npm run docs:build

# Preview production build locally
npm start
```

### Environment Setup
```bash
# Copy environment template
cp .env.example .env.local

# Required environment variables
NEXT_PUBLIC_SITE_URL=https://tecnojr.com.br
```

---

## Deployment Platforms

### Vercel (Recommended)

#### Automatic Deployment
1. **Connect Repository** to Vercel
   - Go to [vercel.com/new](https://vercel.com/new)
   - Import your GitHub repository
   - Vercel auto-detects Next.js

2. **Configure Build Settings**
   - Framework Preset: Next.js
   - Build Command: `npm run build`
   - Output Directory: `.next`
   - Install Command: `npm ci`

3. **Environment Variables**
   - Add in Vercel Dashboard → Settings → Environment Variables
   - `NEXT_PUBLIC_SITE_URL`
   - Any API keys or secrets

4. **Deploy**
   - Every push to `main` deploys to production
   - Feature branches get preview deployments
   - Pull requests get automatic preview URLs

#### Manual Deployment
```bash
# Install Vercel CLI
npm i -g vercel

# Deploy to preview
vercel

# Deploy to production
vercel --prod
```

#### Custom Domain
1. Go to Vercel Dashboard → Project → Settings → Domains
2. Add custom domain: `tecnojr.com.br`
3. Configure DNS records as instructed
4. Enable automatic HTTPS

---

### Netlify

#### Automatic Deployment
1. **Connect Repository**
   - Go to [app.netlify.com/start](https://app.netlify.com/start)
   - Choose GitHub repository

2. **Build Settings**
   - Build command: `npm run build`
   - Publish directory: `.next`
   - Node version: 20.x (in `netlify.toml`)

3. **netlify.toml Configuration**
```toml
[build]
  command = "npm run build"
  publish = ".next"

[[plugins]]
  package = "@netlify/plugin-nextjs"

[build.environment]
  NODE_VERSION = "20"

[[redirects]]
  from = "/*"
  to = "/index.html"
  status = 200
```

#### Netlify CLI
```bash
# Install Netlify CLI
npm i -g netlify-cli

# Login
netlify login

# Deploy
netlify deploy --prod
```

---

### Self-Hosted (VPS/Docker)

#### Docker Deployment
```dockerfile
# Dockerfile
FROM node:20-alpine AS builder
WORKDIR /app
COPY package*.json ./
RUN npm ci
COPY . .
RUN npm run build

FROM node:20-alpine AS runner
WORKDIR /app
ENV NODE_ENV=production
COPY --from=builder /app/next.config.ts ./
COPY --from=builder /app/public ./public
COPY --from=builder /app/.next ./.next
COPY --from=builder /app/node_modules ./node_modules
COPY --from=builder /app/package.json ./package.json

EXPOSE 3000
CMD ["npm", "start"]
```

```bash
# Build Docker image
docker build -t tecnojr-website .

# Run container
docker run -p 3000:3000 -e NEXT_PUBLIC_SITE_URL=https://tecnojr.com.br tecnojr-website
```

#### Docker Compose
```yaml
# docker-compose.yml
version: '3.8'
services:
  web:
    build: .
    ports:
      - "3000:3000"
    environment:
      - NEXT_PUBLIC_SITE_URL=https://tecnojr.com.br
      - NODE_ENV=production
    restart: unless-stopped
```

```bash
# Start services
docker-compose up -d

# View logs
docker-compose logs -f
```

---

## Storybook Deployment

### Deploy to Vercel (Separate)
```bash
# Build Storybook
npm run docs:build

# Deploy storybook-static to Vercel
cd storybook-static
vercel --prod
```

### Deploy to Chromatic (Visual Testing)
```bash
# Install Chromatic
npm install --save-dev chromatic

# Deploy and run visual tests
npx chromatic --project-token=<YOUR_PROJECT_TOKEN>
```

#### Chromatic CI Integration
```yaml
# .github/workflows/chromatic.yml
name: Chromatic
on: push

jobs:
  chromatic:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - run: npm ci
      - run: npx chromatic --project-token=${{ secrets.CHROMATIC_PROJECT_TOKEN }}
```

### Storybook on GitHub Pages
```bash
# Build Storybook
npm run docs:build

# Deploy to gh-pages branch
npx gh-pages -d storybook-static
```

---

## CI/CD Pipelines

### GitHub Actions

#### Main Deployment Workflow
```yaml
# .github/workflows/deploy.yml
name: Deploy

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
      - run: npm ci
      - run: npm run lint
      - run: npm run typecheck

  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
      - run: npm ci
      - run: npm test
      - run: npm run test:e2e
      
  build:
    runs-on: ubuntu-latest
    needs: [lint, test]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
      - run: npm ci
      - run: npm run build
      - uses: actions/upload-artifact@v4
        with:
          name: build
          path: .next

  deploy:
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: build
          path: .next
      - uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'
```

#### Storybook Deployment
```yaml
# .github/workflows/storybook.yml
name: Deploy Storybook

on:
  push:
    branches: [main]

jobs:
  deploy-storybook:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - run: npm ci
      - run: npm run docs:build
      - uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./storybook-static
```

---

## Build Optimization

### Next.js Configuration
```typescript
// next.config.ts
import type { NextConfig } from "next";

const nextConfig: NextConfig = {
  // Production optimizations
  reactStrictMode: true,
  swcMinify: true,
  
  // Image optimization
  images: {
    formats: ["image/avif", "image/webp"],
    deviceSizes: [640, 750, 828, 1080, 1200, 1920, 2048, 3840],
  },
  
  // Compression
  compress: true,
  
  // Bundle analyzer (development only)
  webpack: (config, { isServer }) => {
    if (!isServer && process.env.ANALYZE === "true") {
      const { BundleAnalyzerPlugin } = require("webpack-bundle-analyzer");
      config.plugins.push(
        new BundleAnalyzerPlugin({
          analyzerMode: "static",
          reportFilename: "./analyze.html",
        })
      );
    }
    return config;
  },
};

export default nextConfig;
```

### Analyze Bundle Size
```bash
# Install analyzer
npm install --save-dev @next/bundle-analyzer

# Run with analyzer
ANALYZE=true npm run build

# View report at .next/analyze.html
```

---

## Performance Checklist

### Before Deployment
- [ ] Run `npm run build` successfully
- [ ] Test production build locally with `npm start`
- [ ] Check Lighthouse scores (>90 on all metrics)
- [ ] Verify all images are optimized (Next.js Image)
- [ ] Test on mobile devices (responsive design)
- [ ] Check accessibility (WCAG 2.1 AA)
- [ ] Verify all links work (no 404s)
- [ ] Test forms (contact, budget request)
- [ ] Check meta tags and SEO
- [ ] Verify environment variables are set

### Post-Deployment
- [ ] Monitor real user metrics (Core Web Vitals)
- [ ] Set up error tracking (Sentry)
- [ ] Configure analytics (Google Analytics, Plausible)
- [ ] Set up uptime monitoring
- [ ] Create backups strategy
- [ ] Document deployment process

---

## Monitoring & Analytics

### Error Tracking with Sentry
```bash
# Install Sentry
npm install @sentry/nextjs

# Initialize
npx @sentry/wizard@latest -i nextjs
```

### Analytics
```typescript
// app/layout.tsx
import { Analytics } from "@vercel/analytics/react";

export default function RootLayout({ children }) {
  return (
    <html>
      <body>
        {children}
        <Analytics />
      </body>
    </html>
  );
}
```

---

## Rollback Strategy

### Vercel Rollback
```bash
# List recent deployments
vercel ls

# Rollback to specific deployment
vercel rollback <deployment-url>
```

### Manual Rollback
```bash
# Revert to previous commit
git revert HEAD

# Force push (use with caution)
git push origin main

# Or create rollback PR
git revert <commit-hash>
git push origin rollback-branch
```

---

## Resources

- [Next.js Deployment Docs](https://nextjs.org/docs/app/building-your-application/deploying)
- [Vercel Documentation](https://vercel.com/docs)
- [Storybook Deployment](https://storybook.js.org/docs/sharing/publish-storybook)
- [Chromatic](https://www.chromatic.com/) - Visual testing & review

---

**Deployment Philosophy**: Automate everything, test thoroughly, monitor continuously. Every deployment should be safe, fast, and reversible.
